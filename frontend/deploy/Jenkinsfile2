pipeline {
    agent any

    environment {
        DEPLOYMENT_ENV="dev"
        IMAGE_CREATED_BY="jenkins"
        PROJECT_NAME="lung-cancer"
        REPOSITORY_NAME="ung-cancer-detection"
 
		
        GIT_TAG=sh(returnStdout: true, script: '''        
            echo $(git describe --tags)
        ''').trim()		
 
         //Host specific configuration
        HOST_VOLUME_LOCATION="$JENKINS_DATA_LOCATION"
        M2_REPO="$JENKINS_DATA_LOCATION/.m2"
 
        HARBOR_PROJECT_NAME="lung-cancer"   
        REGISTRY="registry-hacathon.oss.net.bd"
        
        dockerImage = ''
        dockerRegistryCredential='registry-hacathon.oss.net.bd'
        DOCKER_REGISTRY_URL="https://$REGISTRY"
        DEPLOYMENT_TIMEOUT="180s"
 

        PROJECT_LOCATION="$HOST_VOLUME_LOCATION/workspace/$JOB_NAME"
        IMAGE_VERSION="$BUILD_NUMBER-$IMAGE_CREATED_BY-$GIT_TAG-$DEPLOYMENT_ENV"
        IMAGE_REPOSITORY_NAME="$REGISTRY/${HARBOR_PROJECT_NAME}/$PROJECT_NAME"
        DOCKER_TAG="$REGISTRY/$HARBOR_PROJECT_NAME/$PROJECT_NAME:$IMAGE_VERSION"
        DEPLOYMENT_DIRECTORY="./frontend-react"

      

    }

    stages {
    
     stage('Init') {
            steps {
                sh '''
                COMMIT_ID=$(git log -1|head -1|awk -F ' ' ' {print $NF}')
                echo "........result of commit .... $COMMIT_ID"
                '''
            }
        }


      
     stage('Building Docker image') { 
            steps { 
                script { 
                    dockerImage = docker.build("$DOCKER_TAG", "-f ./frontend/Dockerfile .")
                }
                sh '''
                docker images|grep $PROJECT_NAME
                '''
            } 
        }

      stage('Push docker image') {
            steps{
                script {
                    docker.withRegistry( "$DOCKER_REGISTRY_URL", dockerRegistryCredential ) {
                        dockerImage.push()
                        sh "docker images|grep $PROJECT_NAME"
                    }
                    
                }
            }
        }
     

     stage('Deleted image After upload to Registry') {
            steps {
                echo "Cleaning local docker registry $DOCKER_TAG image"
                sh 'docker rmi -f $DOCKER_TAG'
            }
        }
        
         stage('Trigger ManifestUpdate') {
            steps {
                echo "triggering updatemanifestjob"
                build job: "manifest", parameters: [
                    string(name: 'DOCKER_TAG', value: env.DOCKER_TAG),
                ]
            }
        }
        }                    
    }
